<!DOCTYPE html>

<html>
<head>
<!--produced by Vincent Chapdelaine September 2023-->
<!--Goal : Interactive Display of phenotype for purpose of filtering/visualisation
 Necessary file : JSON format, Elements are phenotype, features are descriptions of phenotype,
 Necessary features : "Variable"  "Domain" "Label" # each are used for display titles
 Possible information : All other information are technically optional but highly
                   information are displayed in 4 separate tables : Statistics / Outliers / Samples / Normality and a Filtering option
                   information are displayed according to their feature name pattern : "[Table Name] table row name", the table names are the same as iterated above.
                   Certain statistics are combined if named appropriately, mean [SD] combines [Statistics] mean and [Statistics] SD, range : [Statistics] Minimum /  [Statistics] Maximum, percentile [5,50,95] : [Statistics] PERC_5 [Statistics], median [Statistics], PERC_95
                   If JSON file has mean, Minimum, median, the script will expect the other information to combine.
 Script also expect an image to be found for each element named images/[Variable]_distribution.png
-->
 
<!--External Dependencies: Importing Bootstrap CSS and JS libraries-->
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet"/>
<script crossorigin="anonymous" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" src="https://code.jquery.com/jquery-3.3.1.slim.min.js">
</script>
<script crossorigin="anonymous" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js">
</script>
<script crossorigin="anonymous" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js">
</script>
<title>
   Phenotype filtering
  </title>
<style>
   table {
            border-collapse: collapse;
            width:95%;
            table-layout: auto;
            font-size: 0.8em; /* Smaller font size */
            margin: 0 auto;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        thead {
            font-size: 1.3em;
            margin: 0 auto;
            background-color:#a6a6a6 ;
            colspan:"2";
        }
        .checkbox-cell {
            text-align: center;
        }
        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.5);
        }
        .separator-image {
            display: block;
            max-width: 85%;
            margin-top: 8px;
            margin-bottom: 8px;
            margin-left: 0;
        }
        .save-button {
            margin-top: 16px;
        }
        .headers {
        text-align: center;
        background-color: black;
        color: white;
        }
        .warnings {
        text-align: center;
        background-color: #f75b00;
        color: black;
        font-size: 1.0em;
        border-collapse: collapse;
        width:95%;
        margin: 0 auto;
        }
        .span{
            float: right;
        }
        .div{
            clear:both; 
            overflow:auto;
        }
  </style>
</head>
<!--Body section: Contains the main content of the web page-->
<body>
<!--Main container-->
<div id="jsonContainer">
</div>
<!--Save changes by downloading a version with filters-->
<button class="save-button">
   Save Changes
  </button>
<script>





    function toggleTextbox(vary) {
      const checkbox = document.getElementById(vary+'_box');
      const textbox = document.getElementById(vary+'_text');
      textbox.style.display = checkbox.checked ? 'block' : 'none';
    }

    function toggleTextboxOposite(vary) {
      const checkbox = document.getElementById(vary+'_box');
      const textbox = document.getElementById(vary+'_text');
      textbox.style.display = checkbox.checked ? 'none' : 'block';
    }
    function toggleTextboxOptions(vary) {
      const Options = document.getElementById(vary+'_input');
      const textbox = document.getElementById(vary+'_text');
      textbox.style.display = Options.value !== 'None' ? 'block' : 'none';
    }
  //Function to adress max number of decimal
   function Rounder(number) {
            if (isNaN(number)){ returned = number;}
            else if (String((number- Math. floor(number))).length > 2 ) {returned = number.toFixed(3);}
            else {returned = number;}
        return returned
        }
                // Load JSON file
    var fileInput = document.createElement('input');
    fileInput.type = 'file';

    fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var jsonData = JSON.parse(e.target.result);
            var jsonContainer = document.getElementById("jsonContainer");
            // Generate tables and images for each JSON object
            jsonData.forEach(function(obj, index) {
                var headerKeys = Object.keys(obj);
                headerKeys.splice(1, 0, "Threshold Right");
                headerKeys.splice(1, 0, "Threshold Left");
                headerKeys.splice(1, 0, "To normalize");
                headerKeys.splice(1, 0, "To exclude");
                //Create a header explaining phenotype
                var title= document.createElement("h1");
                title.textContent=obj["Variable"] + '[' + obj["Domain"] + ']' + '(' + obj["Label"]  +')';
                title.classList.add("headers");
                if (obj['problem'].length !==0) {title.style.backgroundColor = "#f75b00"}
                jsonContainer.appendChild(title);
                //Create Container of all tables with bootstrap grid so in-line
                var Container_table = document.createElement('div');
                Container_table.className = "row"  ;
                // 1) Options table
                var Container_table1 = document.createElement('div');
                Container_table1.className = "col" ;
                Container_table1.id = obj["Variable"]+'Container_table1';
                const table1_index = ['To exclude', 'Not normalize', 'Threshold Left', 'Threshold Right'] ;
                var table1 = document.createElement("table");
                var thead1 = table1.createTHead();
                var tbody1 = table1.createTBody();
                thead1.textContent = 'Filters';
                table1_index.forEach(function(key) {
                    row = tbody1.insertRow();
                    var th = document.createElement("th");
                    th.textContent = key;
                    row.appendChild(th);
                    var td = row.insertCell()
                    if (key === "To exclude"){
                        var checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.checked = obj[key] || false;
                        checkbox.id=obj["Variable"]+key+'_box';
                        td.appendChild(checkbox);
                        checkbox.addEventListener('change', function() {
                            jsonData[index][key] = checkbox.checked;
                        });
                        var textbox = document.createElement("input"); 
                        textbox.type="text";
                        textbox.id=obj["Variable"]+key+'_text';
                        textbox.style.display=checkbox.checked !== false ? "block" : "none";
                        textbox.placeholder='Justification to exclude';
                        textbox.value = checkbox.checked !== false ? obj["justification_exclude"].toString() : "";
                        td.appendChild(textbox);
                        checkbox.addEventListener("click", function() {
                            toggleTextbox(obj["Variable"] + key) })
                        }
                    else if (key === "Not normalize"){
                            var checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.checked = obj[key] || false;
                            checkbox.id=obj["Variable"]+key+'_box';
                            td.appendChild(checkbox);
                            checkbox.addEventListener('change', function() {
                                jsonData[index][key] = checkbox.checked;
                            });
                            var textbox = document.createElement("input"); 
                            textbox.type="text";
                            textbox.id=obj["Variable"]+key+'_text';
                            textbox.style.display=checkbox.checked !== false ? "block" : "none";
                            textbox.placeholder='Justification to not normalize';
                            textbox.value = checkbox.checked !== false ? obj["justification_Not_normalize"].toString() : "";
                            td.appendChild(textbox);
                        checkbox.addEventListener("click", function() {
                            toggleTextbox(obj["Variable"] + key)
                        });
                    } else if (key === "Threshold Left" || key === "Threshold Right") { //creates drop down menu
                        var thresholdInput = document.createElement("select");
                        thresholdInput.id=obj["Variable"]+key+'_input';
                        var noneOption = document.createElement("option");
                        noneOption.value = "None";
                        noneOption.text = "None";
                        thresholdInput.add(noneOption);
                        for (var i = 1; i <= 3; i++) {
                            var option = document.createElement("option");
                            option.value = i.toString();
                            option.text = i.toString() + 'SD';
                            thresholdInput.add(option);
                        }
                        thresholdInput.value = obj[key] !== null && obj[key] !== undefined ? obj[key].toString() : "None";
                        thresholdInput.addEventListener('change', function() {
                        jsonData[index][key] = thresholdInput.value !== "None" ? parseInt(thresholdInput.value) : null;
                    })
                        var textbox = document.createElement("input"); 
                        textbox.type="text";
                        textbox.id=obj["Variable"]+key+'_text';
                        textbox.style.display= thresholdInput.value !== 'None' ? "block" : "none";
                        textbox.placeholder='Justification';
                        textbox.value = typeof obj["justification_" + key] !== 'undefined' ? obj["justification_" + key].toString() : "";
                        thresholdInput.addEventListener("click", function() {
                            toggleTextboxOptions(obj["Variable"]+key)
                        });
                        td.appendChild(thresholdInput)
                        td.appendChild(textbox);
                    }
                });
                    Container_table1.appendChild(table1); // table 1 added to Container of table 1

                     // 2) Statistics table

                    var table2 = document.createElement("table");
                    var thead2 = table2.createTHead();
                    var tbody2 = table2.createTBody();
                    thead2.textContent = 'Statistics';
                    var Container_table2 = document.createElement('div');
                    Container_table2.className = "col"
                    Container_table2.id = obj["Variable"]+'_Container_table2';
                    headerKeys.forEach(function(key) {
                        if (key.split(' ')[0] === '[Statistics]'){
                            if (['PERC_95', 'PERC_5', 'SD','median','Maximum'].includes(Statistics)){ continue }
                            Statistics=key.replace('[Statistics]','')
                            row = tbody2.insertRow();
                            var th = document.createElement("th");
                            var td = row.insertCell();
                            if (Statistics == 'mean'){
                                cell = 'μ\u0305 [SD]'
                                rowID= Rounder(obj['Mean']) + ' [' +  Rounder(obj['SD']) +' ]'
                                }
                            else if (key === 'median') {
                                cell = '[' + Rounder(obj['PERC_5']) +' , ' + Rounder(obj['median']) + ' , '+ Rounder(obj['PERC_95']) + ']' ;
                                rowID ='Percentile [5,50,95]'
                                }
                            else if (key === 'Minimum'){
                                cell = '[' + Rounder(obj['Minimum']) +' , ' + Rounder(obj['Maximum']) + ']' 
                                rowID = 'Range'
                            }
                            else {
                                cell = Rounder(obj[key])
                                rowID = key
                            }
                            th.textContent = rowID;
                            row.appendChild(th);
                            td.textContent = cell;
                            if (obj['problem'].includes(Statistics)){
                                th.style.backgroundColor = "#f75b00";
                                td.style.backgroundColor = "#f75b00";
                        }
                        }
                    });
                   Container_table2.appendChild(table2);

                   // 3) Outlier information table
                    var table3 = document.createElement("table");
                    var thead3 = table3.createTHead();
                    var tbody3 = table3.createTBody();
                    thead3.textContent = 'Outliers';
                    var Container_table3 = document.createElement('div');
                    Container_table3.className = "col" ;
                    Container_table3.id = obj["Variable"]+'_Container_table3';
                    headerKeys.forEach(function(key) {
                        outliers=key.replace('[Outliers]','') // all outlier information have this tag
                        if (key.split(' ')[0] === '[Outliers]'){
                            row = tbody3.insertRow();
                            var th = document.createElement("th");
                            th.textContent = outliers.replace('mean','μ\u0305');
                            row.appendChild(th);
                            var td = row.insertCell();
                            td.textContent = Rounder(obj[key]);
                        }
                    });
                   Container_table3.appendChild(table3);

                   // 3) Normality information table
                    var table5 = document.createElement("table");
                    var thead5 = table5.createTHead();
                    var tbody5 = table5.createTBody();
                    thead5.textContent = 'Normality';
                    var Container_table5 = document.createElement('div');
                    Container_table5.className = "col" ;
                    Container_table5.id = obj["Variable"]+'_Container_table5';
                    headerKeys.forEach(function(key) {
                        Normality=key.replace('[Normality]','') // all outlier information have this tag
                        if (key.split(' ')[0] === '[Normality]'){
                            row = tbody3.insertRow();
                            var th = document.createElement("th");
                            th.textContent = Normality
                            row.appendChild(th);
                            var td = row.insertCell();
                            td.textContent = Rounder(obj[key]);
                        }
                    });
                   Container_table5.appendChild(table5);
                   //4) Samples table

                    var table4 = document.createElement("table");
                    var thead4 = table4.createTHead();
                    var tbody4 = table4.createTBody();
                    thead4.textContent = 'Samples';
                    var Container_table4 = document.createElement('div');
                    Container_table4.className = "col" ;
                    Container_table4.id = obj["Variable"]+'_Container_table4';
                    headerKeys.forEach(function(key) { 
                        if (key.split(' ')[0] === '[Samples]'){
                            Samples=key.replace('[Samples]','')
                            row = tbody4.insertRow();
                            var th = document.createElement("th");
                            th.textContent = Samples;
                            row.appendChild(th);
                            var td = row.insertCell();
                            if (obj['problem'].includes(Samples)){
                                th.style.backgroundColor = "#f75b00";
                                td.style.backgroundColor = "#f75b00";
                        }
                        }
                    });
               Container_table4.appendChild(table4);

               // Adding skewness and kurtosis warning
               if (obj['problem'].includes('Total')){
                    var warningTotal= document.createElement("h1");
                    warningTotal.textContent= 'Total is below 100';
                    warningTotal.classList.add("warnings");
                    Container_table4.appendChild(warningTotal);
                }
                if (obj['problem'].includes('Males')){
                    var warningMales= document.createElement("h1");
                    warningMales.textContent= 'Nb Males = 0';
                    warningMales.classList.add("warnings");
                    Container_table4.appendChild(warningMales);
                }
                if (obj['problem'].includes('Females')){
                    var warningFemales= document.createElement("h1");
                    warningFemales.textContent= 'Nb Females = 0';
                    warningFemales.classList.add("warnings");
                    Container_table4.appendChild(warningFemales);
                }
               if (obj['problem'].includes('Mode frequency')){
                    var warningModeF= document.createElement("h1");
                    warningModeF.textContent= 'Mode frequency implies there is a single observation for each value except mode';
                    warningModeF.classList.add("warnings");
                    Container_table2.appendChild(warningModeF);
                }
                if (obj['problem'].includes('N uniques values')){
                    var warningUnique= document.createElement("h1");
                    warningUnique.textContent= 'N uniques values < 10';
                    warningUnique.classList.add("warnings");
                    Container_table2.appendChild(warningUnique);
                }

               // Adding Container tables to Json container
               Container_table.appendChild(Container_table1) ;
               Container_table1.parentNode.insertBefore(Container_table2, Container_table1.nextSibling) ;
               Container_table1.parentNode.insertBefore(Container_table3, Container_table1.nextSibling) ;
               Container_table1.parentNode.insertBefore(Container_table4, Container_table1.nextSibling) ;
               Container_table1.parentNode.insertBefore(Container_table5, Container_table1.nextSibling) ;
               jsonContainer.appendChild(Container_table) ;

               //add image after tables
               if (obj['N uniques values'] > 1) {

               var separatorImage = document.createElement("img");
               separatorImage.src = "images/" + obj[Variable] + "_distribution.png";
               separatorImage.classList.add("separator-image");
               jsonContainer.appendChild(separatorImage);
           }
               })
            // Save Changes button 
            var saveButton = document.querySelector('.save-button');
            saveButton.addEventListener('click', function() {
                saveChanges();
                })
            function saveChanges() {
                // Update jsonData with default values for Included, Normalize and Threshold properties
                jsonData.forEach(function(obj) {
                    ['Not normalize','To exclude'].forEach(function (textName) {
                        textbox = document.getElementById(obj["Variable"]+textName+'_text');
                        checkbox = document.getElementById(obj["Variable"]+textName+'_box');
                        if (checkbox.checked !== false) {
                            obj["justification_" + textName] = textbox.value ;
                        }
                    });
                    ["To exclude", "Not normalize"].forEach(function (checkboxName) {
                        obj[checkboxName] = obj[checkboxName] || false;
                    });
                    ["Threshold Left", "Threshold Right"].forEach(function (thresholdName) {
                        obj[thresholdName] = obj[thresholdName] !== null && obj[thresholdName] !== undefined ? obj[thresholdName] : null;
                         textbox = document.getElementById(obj["Variable"]+thresholdName+'_text');
                        if (obj[thresholdName] !== null && obj[thresholdName] !== undefined) {
                            obj["justification_" + thresholdName] = textbox.value ;
                        }
                    });
                });
                var updatedJsonData = JSON.stringify(jsonData);
                var blob = new Blob([updatedJsonData], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = file.name;
                link.click();
            }
        };

        reader.readAsText(file);
    });

    document.body.appendChild(fileInput);
</script>
</body>
</html>
