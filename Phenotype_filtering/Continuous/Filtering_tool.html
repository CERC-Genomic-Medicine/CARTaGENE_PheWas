<!DOCTYPE html>
<html>
 <head>
  <!--produced by Vincent Chapdelaine September 2023-->
  <!--External Dependencies: Importing Bootstrap CSS and JS libraries-->
  <!-- The goal of this tool is to extract meaningfull information from a JSON file and display it as 4 table/element along with an image / element (tables : filtering tools, Statistics, outlier statistics, and samples Sex statistics) 
   current itteration requieres minimaly the keys : Variable, Domain, Label, Mean, SD, Minimum, Maximum, PERC_5, PERC_95, median, 'Mode',"Mode frequency", 'N uniques values', Total samples, Female samples and Male samples. Optional statistics may also be added.
   To properly display problematic phenotype, we recommend using the X.py script-->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet"/>
  <script crossorigin="anonymous" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" src="https://code.jquery.com/jquery-3.3.1.slim.min.js">
  </script>
  <script crossorigin="anonymous" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js">
  </script>
  <script crossorigin="anonymous" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js">
  </script>
  <title>
   Phenotype filtering
  </title>
  <style>
   table {
            border-collapse: collapse;
            width:95%;
            table-layout: auto;
            font-size: 0.8em; /* Smaller font size */
            margin: 0 auto;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        thead {
            font-size: 1.3em;
            margin: 0 auto;
            background-color:#a6a6a6 ;
            colspan:"2";
        }
        .checkbox-cell {
            text-align: center;
        }
        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.5);
        }
        .separator-image {
            display: block;
            max-width: 85%;
            margin-top: 8px;
            margin-bottom: 8px;
            margin-left: 0;
        }
        .save-button {
            margin-top: 16px;
        }
        .headers {
        text-align: center;
        background-color: black;
        color: white;
        }
        .warnings {
        text-align: center;
        background-color: #f75b00;
        color: black;
        font-size: 1.0em;
        border-collapse: collapse;
        width:95%;
        margin: 0 auto;
        }
        .span{
            float: right;
        }
        .div{
            clear:both; 
            overflow:auto;
        }
  </style>
 </head>
 <!--Body section: Contains the main content of the web page-->
 <body>
  <!--Main container-->
  <div id="jsonContainer">
  </div>
  <!--Save changes by downloading a version with filters-->
  <button class="save-button">
   Save Changes
  </button>
  <script>
  //Function to adress max number of decimal
   function Rounder(number) {
            if (isNaN(number)){ returned = number;}
            else if (String((number- Math. floor(number))).length > 2 ) {returned = number.toFixed(3);}
            else {returned = number;}
        return returned
        }
                // Load JSON file
    var fileInput = document.createElement('input');
    fileInput.type = 'file';

    fileInput.addEventListener('change', function(e) {
        var file = e.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var jsonData = JSON.parse(e.target.result);
            var jsonContainer = document.getElementById("jsonContainer");
            // Generate tables and images for each JSON object
            jsonData.forEach(function(obj, index) {
                var headerKeys = Object.keys(obj);
                headerKeys.splice(1, 0, "Threshold Right");
                headerKeys.splice(1, 0, "Threshold Left");
                headerKeys.splice(1, 0, "To normalize");
                headerKeys.splice(1, 0, "To include");
                //Create a header explaining phenotype
                var title= document.createElement("h1");
                title.textContent=obj["Variable"] + '[' + obj["Domain"] + ']' + '(' + obj["Label"]  +')';
                title.classList.add("headers");
                if (obj['problem'].length !==0) {title.style.backgroundColor = "#f75b00"}
                jsonContainer.appendChild(title);
                //Create Container of all tables with bootstrap grid so in-line
                var Container_table = document.createElement('div');
                Container_table.className = "row"  ;
                // 1) Options table
                var Container_table1 = document.createElement('div');
                Container_table1.className = "col" ;
                Container_table1.id = obj["Variable"]+'Container_table1';
                const table1_index = ['To include', 'To normalize', 'Threshold Left', 'Threshold Right'] ;
                var table1 = document.createElement("table");
                var thead1 = table1.createTHead();
                var tbody1 = table1.createTBody();
                thead1.textContent = 'Filters';
                table1_index.forEach(function(key) {
                    row = tbody1.insertRow();
                    var th = document.createElement("th");
                    th.textContent = key;
                    row.appendChild(th);
                    var td = row.insertCell();
                    if (key === "To include" || key === "To normalize") { //creates check box
                        var checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.checked = obj[key] || false;
                        checkbox.addEventListener('change', function() {
                        jsonData[index][key] = checkbox.checked;
                        });
                        td.appendChild(checkbox);
                    } else if (key === "Threshold Left" || key === "Threshold Right") { //creates drop down menu
                        var thresholdInput = document.createElement("select");
                        var noneOption = document.createElement("option");
                        noneOption.value = "None";
                        noneOption.text = "None";
                        thresholdInput.add(noneOption);
                        for (var i = 1; i <= 3; i++) {
                            var option = document.createElement("option");
                            option.value = i.toString();
                            option.text = i.toString();
                            thresholdInput.add(option);
                        }
                        thresholdInput.value = obj[key] !== null && obj[key] !== undefined ? obj[key].toString() : "None";
                        thresholdInput.addEventListener('change', function() {
                        jsonData[index][key] = thresholdInput.value !== "None" ? parseInt(thresholdInput.value) : null;
                        });
                        td.appendChild(thresholdInput);
                    }
                });
                    Container_table1.appendChild(table1); // table 1 added to Container of table 1

                     // 2) Statistics table

                    const table2_index  = ['x\u0305 [SD]','Range', 'Percentile [5,50,95]', 'Mode',"Mode frequency", 'N uniques values'] ;
                    var table2 = document.createElement("table");
                    var thead2 = table2.createTHead();
                    var tbody2 = table2.createTBody();
                    thead2.textContent = 'Statistics';
                    var Container_table2 = document.createElement('div');
                    Container_table2.className = "col"
                    Container_table2.id = obj["Variable"]+'_Container_table2';
                    table2_index.forEach(function(key) {
                        row = tbody2.insertRow();
                        var th = document.createElement("th");
                        th.textContent = key;
                        row.appendChild(th);
                        var td = row.insertCell();
                        if (key === 'x\u0305 [SD]') { td.textContent = Rounder(obj['Mean']) + ' [' +  Rounder(obj['SD']) +' ]'}
                        else if (key === 'Range') {td.textContent = '[' + Rounder(obj['Minimum']) +' , ' + Rounder(obj['Maximum']) + ']' }
                        else if (key === 'Percentile [5,50,95]') {td.textContent = '[' + Rounder(obj['PERC_5']) +' , ' + Rounder(obj['median']) + ' , '+ Rounder(obj['PERC_95']) + ']' }
                        else {td.textContent = Rounder(obj[key]);}
                        if (obj['problem'].includes(key)){
                            th.style.backgroundColor = "#f75b00";
                            td.style.backgroundColor = "#f75b00";
                        }
                    });
                   Container_table2.appendChild(table2);

                   // 3) Outlier information table
                    var table3 = document.createElement("table");
                    var thead3 = table3.createTHead();
                    var tbody3 = table3.createTBody();
                    thead3.textContent = 'Outliers';
                    var Container_table3 = document.createElement('div');
                    Container_table3.className = "col" ;
                    Container_table3.id = obj["Variable"]+'_Container_table3';
                    headerKeys.forEach(function(key) {
                        outliers=key.replace('[Outliers]','') // all outlier information have this tag
                        if (key.split(' ')[0] === '[Outliers]'){
                            row = tbody3.insertRow();
                            var th = document.createElement("th");
                            th.textContent = outliers.replace('mean','x\u0305');
                            row.appendChild(th);
                            var td = row.insertCell();
                            td.textContent = Rounder(obj[key]);
                        }
                    });
                   Container_table3.appendChild(table3);

                   //4) Samples table

                    const table4_index  = ["Total","Females", "Males"] ;
                    var table4 = document.createElement("table");
                    var thead4 = table4.createTHead();
                    var tbody4 = table4.createTBody();
                    thead4.textContent = 'Samples';
                    var Container_table4 = document.createElement('div');
                    Container_table4.className = "col" ;
                    Container_table4.id = obj["Variable"]+'_Container_table4';
                    table4_index.forEach(function(key) {
                        row = tbody4.insertRow();
                        var th = document.createElement("th");
                        th.textContent = key;
                        row.appendChild(th);
                        var td = row.insertCell();
                        if (key === 'Total') {td.textContent =obj['Total samples']}
                        else if (key === 'Females') {td.textContent =obj['Female samples']}
                        else if (key === 'Males') {td.textContent =obj['Male samples']}
                        if (obj['problem'].includes(key)){
                            th.style.backgroundColor = "#f75b00";
                            td.style.backgroundColor = "#f75b00";
                        }
                    });
               Container_table4.appendChild(table4);

               // Adding skewness and kurtosis warning
               if (obj['problem'].includes('Skewness')){
                    var warningSkew= document.createElement("h1");
                    warningSkew.textContent='* |Skewness| is high ( ' + obj['Skewness'] +' )';
                    warningSkew.classList.add("warnings");
                    Container_table1.appendChild(warningSkew);
                }
               if (obj['problem'].includes('Kurtosis')){
                    var warningKurt= document.createElement("h1");
                    warningKurt.textContent= '* |Kurtosis| is high ( ' + obj['Kurtosis'] +' )';
                    warningKurt.classList.add("warnings");
                    Container_table1.appendChild(warningKurt);
                }
               if (obj['problem'].includes('Total')){
                    var warningTotal= document.createElement("h1");
                    warningTotal.textContent= 'Total is below 100';
                    warningTotal.classList.add("warnings");
                    Container_table4.appendChild(warningTotal);
                }
                if (obj['problem'].includes('Males')){
                    var warningMales= document.createElement("h1");
                    warningMales.textContent= 'Nb Males = 0';
                    warningMales.classList.add("warnings");
                    Container_table4.appendChild(warningMales);
                }
                if (obj['problem'].includes('Females')){
                    var warningFemales= document.createElement("h1");
                    warningFemales.textContent= 'Nb Females = 0';
                    warningFemales.classList.add("warnings");
                    Container_table4.appendChild(warningFemales);
                }
               if (obj['problem'].includes('Mode frequency')){
                    var warningModeF= document.createElement("h1");
                    warningModeF.textContent= 'Mode frequency implies there is a single observation for each value except mode';
                    warningModeF.classList.add("warnings");
                    Container_table2.appendChild(warningModeF);
                }
                if (obj['problem'].includes('N uniques values')){
                    var warningUnique= document.createElement("h1");
                    warningUnique.textContent= 'N uniques values < 10';
                    warningUnique.classList.add("warnings");
                    Container_table2.appendChild(warningUnique);
                }

               // Adding Container tables to Json container
               Container_table.appendChild(Container_table1) ;
               Container_table1.parentNode.insertBefore(Container_table2, Container_table1.nextSibling) ;
               Container_table1.parentNode.insertBefore(Container_table3, Container_table1.nextSibling) ;
               Container_table1.parentNode.insertBefore(Container_table4, Container_table1.nextSibling) ;
               jsonContainer.appendChild(Container_table) ;

               //add image after tables
               if (obj['N uniques values'] > 1) {

               var separatorImage = document.createElement("img");
               separatorImage.src = "images/" + obj[Object.keys(obj)[0]].split(" ")[0] + "_distribution.png";
               separatorImage.classList.add("separator-image");
               jsonContainer.appendChild(separatorImage);
           }
               })
            // Save Changes button 
            var saveButton = document.querySelector('.save-button');
            saveButton.addEventListener('click', function() {
                saveChanges();
                })
            function saveChanges() {
                // Update jsonData with default values for Included, Normalize and Threshold properties
                jsonData.forEach(function(obj) {
                    ["To include", "To normalize"].forEach(function (checkboxName) {
                        obj[checkboxName] = obj[checkboxName] || false;
                    });
                    ["Threshold Left", "Threshold Right"].forEach(function (thresholdName) {
                        obj[thresholdName] = obj[thresholdName] !== null && obj[thresholdName] !== undefined ? obj[thresholdName] : null;
                    });
                });
                var updatedJsonData = JSON.stringify(jsonData);
                var blob = new Blob([updatedJsonData], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = file.name;
                link.click();
            }
        };

        reader.readAsText(file);
    });

    document.body.appendChild(fileInput);
  </script>
 </body>
</html>
